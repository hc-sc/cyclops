--01.patch
--author:  Ramy Ghonaim
--date:    09/05/2019

ALTER TABLE xr_roa_by_df_min_age
ADD (DFU_AGE_UNIT_ID NUMBER,
        DFU_AGE_UNIT_CODE VARCHAR2(50));

UPDATE xr_roa_by_df_min_age
SET DFU_AGE_UNIT_CODE = 'yr'
WHERE DFU_AGE_UNIT_CODE is null;

UPDATE xr_roa_by_df_min_age
SET DFU_AGE_UNIT_ID = 169
WHERE DFU_AGE_UNIT_CODE = 'yr';

-----

drop table x$roa_dosage_form;

create table x$roa_dosage_form as
with xi as (
select /*+ materialize */
       unique nvl(x.product_mono_code, x.mono_code) mono_code, x.dosage_form_group_code
  from x_ingredient_matrix x
)
,xm as (
select xi.*, xm.nhpid_mono_code
  from xi, x_monograph xm
where xi.mono_code = nvl(xm.product_mono_code, xm.mono_code)
)
,x as (
select xm.*, xdf.dosage_form_nhpid_code, xdf.dosage_form_decode, xdf.roa--, xdf.age_unit
  from xm, x_dosage_form xdf
where 1=1
   and xm.dosage_form_group_code = xdf.dosage_form_group_code
)
,q as (
select v.adminrt_id admin_route_id, df.dosefrm_id dosage_form_id,
       v.admin_route_code, df.dosefrm_code dosage_form_code
  from x, dosage_forms df,
       v_monograph_roa v
where 1=1
   and x.roa = v.admin_route_name_eng
   and x.nhpid_mono_code = v.mono_code
   and x.dosage_form_nhpid_code = df.dosefrm_code
union
select ar.adminrt_id, df.dosefrm_id,
       ar.adminrt_code, df.dosefrm_code
  from xr_roa_by_df x, ADMINISTRATION_ROUTES ar, DOSAGE_FORMS df
where x.roa_code = ar.adminrt_name_eng
   and x.df_code = df.dosefrm_code
)
select q.admin_route_id, q.dosage_form_id, du.dfu_id,
       to_number(xma.min_age) min_age, to_number(xma.dfu_min_age) dfu_min_age, xma.age_unit_code, xma.dfu_age_unit_code
  from q, xr_roa_by_df_min_age xma, x$dfu_xref du
where q.admin_route_code = xma.roa(+)
   and q.dosage_form_code = xma.df(+)
   and xma.comments = du.dfu_group_code(+)
;

-----

  create or replace force view 
  v_roa_dosage_forms
  as
  select ar.adminrt_code admin_route_code,
       df.dosage_form_syn_code,
       df.dosage_form_code,
       ar.adminrt_name_eng admin_route_name_eng, ar.adminrt_name_fr admin_route_name_fr,
       ar.adminrt_no_fixed_limits admin_route_no_fixed_limits,
       ar.adminrt_sterilerequired admin_route_sterile_required,
       df.dosage_form_name_eng,
       df.dosage_form_name_fr,
       rdf.min_age,
       rdf.dfu_min_age,
       rdf.age_unit_code,
       rdf.dfu_age_unit_code,
       dfu.dfu_group_code,
       dfu.dfu_group_decode_eng dfu_decode_eng,
       dfu.dfu_group_decode_fr dfu_decode_fr,
       df.dosefrm_id, ar.adminrt_id
  from x$roa_dosage_form rdf,
       administration_routes ar,
       v_dosage_forms df,
       x$dfu_xref dfu
where rdf.admin_route_id = ar.adminrt_id
   and rdf.dosage_form_id = df.dosefrm_id
   and rdf.dfu_id = dfu.dfu_id(+)
;

grant select on v_roa_dosage_forms to nhpdweb_user;
create or replace synonym nhpdweb_user.v_roa_dosage_forms for v_roa_dosage_forms;
