-----------------------------------
--patch #24
-- date: 2019/10/30
-- fixes: WPLA-365, DB-235
----------------------------------
spool patch_24.log
prompt Patch 24
prompt ---------
prompt v_source_ingredient
create or replace force view
v_source_ingredient
as
-- non compendial sources
select i.ingred_authorized_name_eng ingred_nhpid_name_eng, 
       i.ingred_authorized_name_fr ingred_nhpid_name_fr, 
       si.ingred_authorized_name_eng source_nhpid_name_eng, 
       si.ingred_authorized_name_fr source_nhpid_name_fr, 
       null product_mono_code,
       null single_mono_code,
       null mono_code,
       null mono_id,
       i.ingred_id ingredient_id, 
       si.ingred_id source_id, 
       si.ingredcat_id src_name_type_id, 
       p.prep_type_id preparation_id
  from SUBINGREDIENTS s,
       INGREDIENT_SUBINGREDIENTS ins,
       INGREDIENTS si,
       INGREDIENTS i,
       x$ingredient_prep_code p
 where 1=1
   and s.subingred_id = ins.subingred_id
   and ins.ingred_id = si.ingred_id
   and s.ingred_id = i.ingred_id
   and s.subingred_id not in (select subingred_id from ORGANISM_PART_SUBINGREDIENTS)
   and si.ingred_id = p.ingred_id(+)
 union 
-- compendial sources
select m.ingred_nhpid_name_eng,
       m.ingred_nhpid_name_fr,
       m.source_nhpid_name_eng,
       m.source_nhpid_name_fr,
       m.product_mono_code,
       m.single_mono_code,
       m.mono_code,
       --'Source '||nvl2(nvl(q.source_org_part_id, x.orgparttype_id),'Material','Ingredient') source_type,
       m.mono_id,
       m.ingredient_id,
       m.source_id,
       m.src_name_type_id,
       p.prep_type_id preparation_id
  from v_mono_source_ingredient m,
       x$organism_ingredient x,
       v_source_organism_parts Q, 
       x$ingredient_prep_code p
 where 1=1
   and m.ingredient_id = x.ingred_id
   and nvl(m.product_mono_code,'x') = nvl(x.product_mono_code,'x')
   and m.single_mono_code = x.mono_code
   and m.source_id = x.source_id
   and x.organism_id is null
   and x.ingred_id = q.ingred_id(+)
   and x.source_id = q.source_ingred_id(+)
   and nvl(x.product_mono_code,'x') = nvl(q.product_mono_code(+),'x')
   and x.mono_code = q.mono_code(+)
   and x.orgparttype_id= q.source_org_parttype_id(+)
   and m.source_id = p.ingred_id(+)
   and q.source_org_part_id is null and x.orgparttype_id is null
 union 
-- non monograph sources of type "source ingredient"
select i.ingred_authorized_name_eng,
       i.ingred_authorized_name_fr,
       ing.ingred_authorized_name_eng,
       ing.ingred_authorized_name_fr,
       null product_mono_code,
       null mono_code,
       null mono_code_nhpid,
       --'Source Ingredient',
       null mono_id,
       subs.ingred_id,
       ing.ingred_id,
       ing.ingredcat_id,
       p.prep_type_id preparation_id
  from INGREDIENTS ing,
       INGREDIENT_SUBINGREDIENTS ingsub,
       SUBINGREDIENTS subs,
       INGREDIENTS i,
       x$ingredient_prep_code p
 where ing.ingred_id = ingsub.ingred_id
   and ingsub.subingred_id = subs.subingred_id
   and ing.ingredspec_class_name = 'ChemicalSubstance'
   and i.ingred_id = subs.ingred_id
   and ing.ingred_id = p.ingred_id(+)
;

prompt ---------
prompt v_source_material
create or replace force view
v_source_material
as
-- non compendial sources
select i.ingred_authorized_name_eng ingred_nhpid_name_eng, 
       i.ingred_authorized_name_fr ingred_nhpid_name_fr, 
       i.ingred_authorized_name_eng source_nhpid_name_eng, 
       i.ingred_authorized_name_fr source_nhpid_name_fr, 
       null product_mono_code,
       null single_mono_code,
       null mono_code,
       null mono_id,
       i.ingred_id ingredient_id, 
       i.ingred_id source_id, 
       i.ingredcat_id src_name_type_id, 
       t.organism_id, 
       t.organism_name, 
       t.orgtype_id organism_type_id, 
       t.orgtype_name_eng organism_type_name_eng, 
       t.orgtype_name_fr organism_type_name_fr, 
       t.org_group_id,
       t.org_group_name_eng,
       t.org_group_name_fr, 
       p.prep_type_id preparation_id,
       t.orgparttype_id source_material_part_id, 
       t.orgparttype_code source_material_part_type_code, 
       t.orgparttype_name_eng source_material_part_name_eng, 
       t.orgparttype_name_fr source_material_part_name_fr, 
       null source_material_strain, 
       t.orgparttype_id
  from v_ingredient_organism_parts t,
       INGREDIENTS i,
       x$ingredient_prep_code p
 where t.ingred_id = i.ingred_id
   and t.ingred_id = p.ingred_id(+)
 union  
-- compendial sources
select m.ingred_nhpid_name_eng,
       m.ingred_nhpid_name_fr,
       m.source_nhpid_name_eng,
       m.source_nhpid_name_fr,
       m.product_mono_code,
       m.single_mono_code,
       m.mono_code,
       --'Source '||nvl2(nvl(q.source_org_part_id, x.orgparttype_id),'Material','Ingredient') source_type,
       m.mono_id,
       m.ingredient_id,
       m.source_id,
       m.src_name_type_id,
       x.organism_id,
       q.organism_name,
       q.orgtype_id organism_type_id,
       q.orgtype_name_eng organism_type_name_eng,
       q.orgtype_name_fr organism_type_name_fr,
       q.source_org_group_id organism_group_id, 
       q.source_org_group_name_eng organism_group_name_eng, 
       q.source_org_group_name_fr organism_group_name_fr, -- vp added groups
       p.prep_type_id preparation_id,
       nvl(q.source_org_part_id, x.orgparttype_id) source_material_part_id,
       q.source_org_parttype_code source_material_part_type_code,
       q.source_org_parttype_name_eng source_material_part_name_eng,
       q.source_org_parttype_name_fr source_material_part_name_fr,
       x.source_material_strain,
       x.orgparttype_id
  from v_mono_source_ingredient m,
       x$organism_ingredient x,
       v_source_organism_parts Q, 
       x$ingredient_prep_code p
 where 1=1
   and m.ingredient_id = x.ingred_id
   and nvl(m.product_mono_code, 'x') = nvl(x.product_mono_code, 'x')
   and m.single_mono_code = x.mono_code
   and m.ingredient_id = q.ingred_id
   and m.source_id =  q.source_ingred_id
   and x.organism_id = q.source_org_id
   and x.orgparttype_id = q.source_org_parttype_id
--   and x.ingred_id = q.ingred_id
   and m.source_id = p.ingred_id(+)
   and nvl(q.source_org_part_id, x.orgparttype_id) is not null
 union 
select m.ingred_nhpid_name_eng,
       m.ingred_nhpid_name_fr,
       m.source_nhpid_name_eng,
       m.source_nhpid_name_fr,
       m.product_mono_code,
       m.single_mono_code,
       m.mono_code,
       --'Source '||nvl2(nvl(q.source_org_part_id, x.orgparttype_id),'Material','Ingredient') source_type,
       m.mono_id,
       m.ingredient_id,
       m.source_id,
       m.src_name_type_id,
       x.organism_id,
       q.organism_name,
       q.orgtype_id organism_type_id,
       q.orgtype_name_eng organism_type_name_eng,
       q.orgtype_name_fr organism_type_name_fr,
       q.source_org_group_id organism_group_id, 
       q.source_org_group_name_eng organism_group_name_eng, 
       q.source_org_group_name_fr organism_group_name_fr, -- vp added groups
       p.prep_type_id preparation_id,
       nvl(q.source_org_part_id, x.orgparttype_id) source_material_part_id,
       q.source_org_parttype_code source_material_part_type_code,
       q.source_org_parttype_name_eng source_material_part_name_eng,
       q.source_org_parttype_name_fr source_material_part_name_fr,
       x.source_material_strain,
       x.orgparttype_id
  from v_mono_source_ingredient m,
       x$organism_ingredient x,
       v_source_organism_parts Q, 
       x$ingredient_prep_code p
 where 1=1
   and m.ingredient_id = x.ingred_id
   and nvl(m.product_mono_code,'x') = nvl(x.product_mono_code,'x')
   and m.single_mono_code = x.mono_code
   and m.source_id = x.source_id
   and x.organism_id is null
   --
   and x.ingred_id = q.ingred_id(+)
   and x.source_id = q.source_ingred_id(+)
   and nvl(x.product_mono_code,'x') = nvl(q.product_mono_code(+),'x')
   and x.mono_code = q.mono_code(+)
   and x.orgparttype_id= q.source_org_parttype_id(+)
--   and q.orgtype_id is null
   --
   and m.source_id = p.ingred_id(+)
   and nvl(q.source_org_part_id, x.orgparttype_id) is not null
 union 
select m.ingred_nhpid_name_eng,
       m.ingred_nhpid_name_fr,
       m.source_nhpid_name_eng,
       m.source_nhpid_name_fr,
       m.product_mono_code,
       m.single_mono_code,
       m.mono_code,
       --'Source '||nvl2(q.source_org_part_id,'Material','Ingredient') source_type,
       m.mono_id,
       m.ingredient_id,
       m.source_id,
       t.src_name_type_id,
       q.source_org_id,
       q.organism_name,
       q.orgtype_id organism_type_id,
       q.orgtype_name_eng organism_type_name_eng,
       q.orgtype_name_fr organism_type_name_fr,
       q.source_org_group_id organism_group_id, 
       q.source_org_group_name_eng organism_group_name_eng, 
       q.source_org_group_name_fr organism_group_name_fr, -- vp added groups
       p.prep_type_id preparation_id,
       q.source_org_part_id source_material_part_id,
       q.source_org_parttype_code source_material_part_type_code,
       q.source_org_parttype_name_eng source_material_part_name_eng,
       q.source_org_parttype_name_fr source_material_part_name_fr,
       null source_material_strain,
       q.source_org_parttype_id orgparttype_id
  from v_mono_source_ingredient t,
       v_mono_source_ingredient m,
       v_source_organism_parts Q, 
       x$ingredient_prep_code p
 where 1=1
   and nvl(t.product_mono_code,'x') = nvl(m.product_mono_code,'x') -- vp case ingred_id = 1548
   and t.single_mono_code = m.mono_code -- vp case ingred_id = 1548
   and t.ingredient_id = m.ingredient_id
   and t.source_id = m.source_id
   --
   and nvl(m.product_mono_code,'x') = nvl(q.product_mono_code,'x') -- vp case ingred_id = 1548
   and m.single_mono_code = q.mono_code -- vp case ingred_id = 1548
   and m.ingredient_id = q.ingred_id
   and m.source_id = p.ingred_id(+)
   and q.source_org_part_id is not null
 union 
-- non ingredient organisms
select n.ingred_authorized_name_eng nhpid_ingred_name_eng,
       n.ingred_authorized_name_fr nhpid_ingred_name_fr,
       null nhpid_source_name_eng,
       null nhpid_source_name_fr,
       q.product_mono_code,
       q.mono_code,
       q.mono_code_nhpid,
       --'Source Material' source_type,
       q.mono_id,
       nvl(q.ingred_id,mi.ingred_id) ingred_id,--null ingredient_id,
       q.source_ingred_id source_id,
       null src_ingred_cat_id,
       q.source_org_id organism_id,
       q.organism_name,
       q.orgtype_id organism_type_id,
       q.orgtype_name_eng organism_type_name_eng,
       q.orgtype_name_fr organism_type_name_fr,
       q.source_org_group_id organism_group_id, 
       q.source_org_group_name_eng organism_group_name_eng, 
       q.source_org_group_name_fr organism_group_name_fr, -- vp added groups
       p.prep_type_id preparation_id,
       --q.source_org_part_id source_material_part_id,
       nvl(q.source_org_part_id,q.source_org_parttype_id) source_material_part_id, -- artificial ID substitution
       q.source_org_parttype_code source_material_part_type_code,
       q.source_org_parttype_name_eng source_material_part_name_eng,
       q.source_org_parttype_name_fr source_material_part_name_fr,
       null source_material_strain,
       q.source_org_parttype_id orgparttype_id
  from INGREDIENTS i,
       v_source_organism_parts Q, 
       x$non_ingred_orgnsm_prep_code p,
       x$monograph_ingredients_xref mi,
       INGREDIENTS n
 where lower(trim(q.organism_name)) = lower(trim(i.ingred_authorized_name_eng(+)))
   and i.ingred_id is null
   and lower(trim(q.organism_name)) = lower(trim(p.organism_name(+)))
   and nvl(q.product_mono_code,'x') = nvl(mi.product_mono_code(+),'x')
   and q.mono_code = mi.mono_code(+)
   and mi.ingred_id = n.ingred_id(+)
union 
-- orphan source organism types
select i.ingred_authorized_name_eng nhpid_ingred_name_eng,
       i.ingred_authorized_name_fr nhpid_ingred_name_fr,
       null nhpid_source_name_eng,
       null nhpid_source_name_fr,
       mx.product_mono_code,
       mx.mono_code,
       mx.mono_code_nhpid,
       --'Source Material' source_type,
       mx.mono_id,
       mx.ingred_id_nhpid ingredient_id,
       null source_id,
       null src_ingred_cat_id,
       null,--q.source_org_id,
       null,--q.organism_name,
       mx.organism_type_id,
       ot.orgtype_name_eng organism_type_name_eng,
       ot.orgtype_name_fr organism_type_name_fr,
       null organism_group_id, 
       null organism_group_name_eng, 
       null organism_group_name_fr, -- vp added groups
       p.prep_type_id preparation_id,
       mx.orgparttype_id source_material_part_id,
       mx.orgparttype_code source_material_part_type_code,
       mx.orgparttype_name_eng source_material_part_name_eng,
       mx.orgparttype_name_fr source_material_part_name_fr,
       null source_material_strain,
       mx.orgparttype_id
  from x$orphan_source_organism_types mx,
       organism_types ot,
       x$non_ingred_orgnsm_prep_code p,
       INGREDIENTS i
 where 1=1
   and mx.organism_type_id = ot.orgtype_id
   and mx.ingred_id_nhpid = i.ingred_id(+)
   and mx.source_prep_code = p.source_prep_code(+)
;

prompt ---------
prompt v_mono_ingredient_uses
create or replace force view
v_mono_ingredient_uses
as
select t.mono_code, d.ingredient_id, d.ingred_name_eng, 
       t.use_code, t.use_decode_eng, t.use_decode_fr, d.admin_route_code,
       decode(instr(lower(t.use_decode_eng),'traditional'),0,'General','Traditional') use_type
  from v_assessment_doses d,
       v_assessment_dose_use t
 where d.assessment_dose_id = t.assessment_dose_id
--   and d.ingredient_id not in (select subingredient_id from v_mono_subingreds)
 union
select t2.mono_code, s.ingred_id ingredient_id, s.ingred_nhpid_name, 
       t2.use_code, t2.use_decode_eng, t2.use_decode_fr, d2.admin_route_code,
       decode(instr(lower(t2.use_decode_eng),'traditional'),0,'General','Traditional') use_type
  from v_mono_subingreds s, 
       v_assessment_doses d2, 
       v_assessment_dose_use t2
 where s.subingredient_id = d2.ingredient_id
   and s.mono_code = d2.mono_code
   and t2.assessment_dose_id = d2.assessment_dose_id
;

prompt ---------
prompt revoke grants and drop synonyms
revoke all on v_all_sources from NHPDWEB_BUFFER;
revoke all on v_all_sources from NHPDWEB_USER;
revoke all on v_all_sources from NHPID_APEX;
revoke all on v_all_sources from PUBLIC;
revoke all on v_all_sources from R_NHPD_ING_READ;
revoke all on v_all_sources from RL__NHPDWEB_ADMIN;
revoke all on v_all_sources from RL__NHPDWEB_READ;

revoke all on v_non_compendial_sources from NHPDWEB_BUFFER;
revoke all on v_non_compendial_sources from NHPDWEB_USER;
revoke all on v_non_compendial_sources from NHPID_APEX;
revoke all on v_non_compendial_sources from PUBLIC;
revoke all on v_non_compendial_sources from R_NHPD_ING_READ;
revoke all on v_non_compendial_sources from RL__NHPDWEB_ADMIN;
revoke all on v_non_compendial_sources from RL__NHPDWEB_READ;

drop public synonym v_all_sources;
drop public synonym v_non_compendial_sources;

prompt ---------
prompt compile schema and show errors

exec dbms_utility.compile_schema(user);

select object_name, object_type from user_objects where status = 'INVALID';

set linesize 1000 pagesize 9999 trimspool on
col name for a30
col line for 99999
col message_number for 99999
col text for a132
select t.name,
       t.line,
       t.message_number,
       t.text
  from user_errors t
;

spool off

