-----------------------------------
--patch #36
-- date: 2019/11/19
-- fixes: DB-229
----------------------------------
define pth=36
spool patch_&pth..log
prompt Patch &&pth
set timing on

prompt ---------
prompt update X_PREP_METHOD
set feedback off
set define off
update X_PREP_METHOD set NHPID_PREP_CODE = 'ISO' where ROW_ID = 54;
update X_PREP_METHOD set NHPID_PREP_CODE = 'SYNTH' where ROW_ID = 218;

commit;

prompt ---------
prompt refresh prep data

alter table X$ASSESSMENT_DOSE_MOP drop constraint X$ASSESSMENT_DOSE_MOP_FK1;

prompt x$preparation_methods_xref
truncate table x$preparation_methods_xref;
insert into  x$preparation_methods_xref
(prep_method_id, prep_type_id, --prep_type_code, approved_name, 
 unique_prep_code, unique_prep_description_eng, unique_prep_description_fr, 
 prep_group_code, potency, extract, ratio_type, solvents, 
 quantity_crude_equivalent, solvent_list_id, useracc_id, creation_date) -- vp added FRESH/DRY
select rownum prep_method_id, q.*
  from (select unique
       pt.prep_type_id,
--       pt.prep_type_code,
--       pt.approved_name,
       xp.unique_prep_code, 
       xp.unique_prep_description unique_prep_description_eng, 
       xp.unique_prep_description_fr, 
       xp.prep_group_code, 
       decode(lower(pt.potency),'required','y','-',null,lower(pt.potency)) potency, 
       decode(lower(pt.extract),'required','y','optional','n','-',null,lower(pt.extract)) extract, 
       replace(pt.ratio_type,'-') ratio_type,
       decode(lower(pt.solvents),'required','y','optional','n','-',null,lower(pt.solvents)) solvents, 
       decode(lower(pt.quantity_crude_equivalent),'required','y','optional','n','-',null,lower(pt.quantity_crude_equivalent)) quantity_crude_equivalent,
       to_number(substr(xp.solvent_group_code,3)) solvent_list_id,
       0, trunc(sysdate)
  from x_prep_method xp,
       x$prep_type_info_xref pt
 where xp.nhpid_prep_code = pt.prep_type_code(+)
 order by 1 nulls last
) q 
;
commit;

alter table X$ASSESSMENT_DOSE_MOP add constraint X$ASSESSMENT_DOSE_MOP_FK1 foreign key (PREP_METHOD_ID)
  references X$PREPARATION_METHODS_XREF (PREP_METHOD_ID);

prompt x$ingredient_prep_code
truncate table x$ingredient_prep_code;
insert into x$ingredient_prep_code
(ingred_id, nhpid_name, prep_group_code, prep_type_id, source_group_code, 
product_mono_code, single_mono_code, mono_code, mono_id, source_prep_code, ingred_prep_code_id, useracc_id, creation_date)
with q as (
select --unique 
       to_number(xi.ingred_id_nhpid) ingred_id, xi.nhpid_name, 
       upper(xi.prep_group_code) prep_group_code,
       xpm.prep_type_id, xi.source_group_code,
       xi.product_mono_code, xi.mono_code single_mono_code,
       xmi.mono_code, xmi.mono_id,
       null source_prep_code
  from x_ingredient_matrix xi, 
       x$preparation_methods_xref xpm,
       x$monograph_ingredients_xref xmi
 where upper(xi.prep_group_code) = upper(xpm.prep_group_code)
   and nvl(xi.product_mono_code,'x') = nvl(xmi.product_mono_code,'x')
   and  xi.mono_code = xmi.single_mono_code
   and to_number(xi.ingred_id_nhpid) = xmi.ingred_id
union
select to_number(xi.subing_id_nhpid)  ingred_id, xi.subing_name_nhpid, 
       upper(xi.prep_group_code) subing_prep_code,
       xpm.prep_type_id, xi.source_group_code,
       xi.product_mono_code, xi.mono_code single_mono_code, 
       xmi.mono_code, xmi.mono_id,
       null source_prep_code
  from x_sub_ingredient_matrix xi, 
       x$preparation_methods_xref xpm,
       x$monograph_ingredients_xref xmi
 where xi.prep_group_code = xpm.prep_group_code
   and nvl(xi.product_mono_code,'x') = nvl(xmi.product_mono_code,'x')
   and  xi.mono_code = xmi.single_mono_code
   and to_number(xi.ingred_id_nhpid) = xmi.ingred_id
union
select --unique 
       to_number(si.source_ingred_id_nhpid) ingred_id, si.source_nhpid_name, 
       null prep_group_code,
       xpm.prep_type_id, si.source_group_code,
       si.product_mono_code, si.mono_code single_mono_code,
       xmi.mono_code, xmi.mono_id,
       upper(si.source_prep_code) source_prep_code
  from x_sources si, 
       x$preparation_methods_xref xpm,
       x$monograph_ingredients_xref xmi
 where upper(si.source_prep_code) = upper(xpm.prep_group_code)
   and nvl(si.product_mono_code,'x') = nvl(xmi.product_mono_code,'x')
   and  si.mono_code = xmi.single_mono_code
   and to_number(si.source_ingred_id_nhpid) = xmi.ingred_id
union
select unique 
       to_number(si.source_ingred_id_nhpid) ingred_id, si.source_nhpid_name, 
       null prep_group_code,
       xpm.prep_type_id, si.source_group_code,
       si.product_mono_code, si.mono_code single_mono_code,
       xmi.mono_code_nhpid mono_code, 
       xmi.monograph_id mono_id,
       upper(si.source_prep_code) source_prep_code
  from x_sources si, 
       x$preparation_methods_xref xpm,
       x$mono_source_ingredient xmi --x$monograph_ingredients_xref xmi
 where upper(si.source_prep_code) = upper(xpm.prep_group_code)
   and nvl(si.product_mono_code,'x') = nvl(xmi.product_mono_code,'x')
   and  si.mono_code = xmi.mono_code --single_mono_code
   and to_number(si.source_ingred_id_nhpid) = xmi.source_id --ingred_id
)
select unique q.*, rownum ingred_prep_code_id,  0, trunc(sysdate) from q 
;
commit;


prompt ---------
prompt compile schema and show errors

exec dbms_utility.compile_schema(user);

select object_name, object_type from user_objects where status = 'INVALID';

set linesize 1000 pagesize 9999 trimspool on
col name for a30
col line for 99999
col message_number for 99999
col text for a132
select t.name,
       t.line,
       t.message_number,
       t.text
  from user_errors t
;
update x$version set schema_version = '0.&&pth', data_version = '20191119';
commit;

spool off

