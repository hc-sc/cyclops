-----------------------------------
--patch #30
-- date: 2019/11/07
-- fixes: fix MOP FRESH/DRY
----------------------------------
define pth=30
spool patch_&pth.log
prompt Patch &&pth

prompt ---------
prompt v_assessment_dose_mop
create or replace force view 
v_assessment_dose_mop
as
select distinct 
       x.prep_method_id,
       ad.assessment_dose_id,
       ad.mono_code,
       ad.product_mono_code,
       ad.single_mono_code,
       --
       sp.prep_group_code,
       sp.unique_prep_code,
       sp.unique_prep_description_eng prep_group_decode_eng,
       sp.unique_prep_description_fr prep_group_decode_fr,
       pt.preptype_code prep_type_code,
       sp.potency, sp.extract, sp.ratio_type, sp.solvents, 
       sl.solvent_list_decode_eng solvent_list, 
       sp.quantity_crude_equivalent,
       case when regexp_like(lower(sp.unique_prep_description_eng),'dry|dried') then 'DRY'
            when regexp_like(lower(sp.unique_prep_description_eng),'fresh') then 'FRESH'
       end prep_group_type,
       sp.solvent_list_id, sp.prep_type_id,
       ad.ingredient_id, ad.sub_ingredient_id, ad.source_ingredient_id
  from x$assessment_dose_mop x,
       v_assessment_doses ad,
       x$preparation_methods_xref sp,
       PREPARATION_TYPES pt,
       x$solvent_lists sl
 where x.assessment_dose_id = ad.assessment_dose_id
   and x.prep_method_id = sp.prep_method_id
   and sp.prep_type_id = pt.preptype_id(+)
   and sp.solvent_list_id = sl.solvent_list_id(+)
;

prompt ---------
prompt compile schema and show errors

exec dbms_utility.compile_schema(user);

select object_name, object_type from user_objects where status = 'INVALID';

set linesize 1000 pagesize 9999 trimspool on
col name for a30
col line for 99999
col message_number for 99999
col text for a132
select t.name,
       t.line,
       t.message_number,
       t.text
  from user_errors t
;
update x$version set schema_version = to_number('0.&&pth','9.999');
commit;

spool off

