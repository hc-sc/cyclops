-----------------------------------
--patch #29
-- date: 2019/11/06
-- fixes: 
----------------------------------
spool patch_29.log
prompt Patch 29

prompt ---------
prompt Create source temp table
create table X$ASSESSMENT_DOSE_XREF_x as
select t.assess_dose_id,
       t.product_mono_code,
       t.single_mono_code,
       t.source_group_code,
       t.group_group_id,
       t.group_id,
       t.combo_dose_code,
       t.version,
       t.ingredient_id_nhpid,
       t.nhpid_name,
       t.mi_dose_type,
to_number(qdu_min) qdu_min,
to_number(qdu_max) qdu_max, 
to_number(regexp_substr(t.qie_min,'[0-9.]+')) qie_min,
to_number(regexp_substr(t.qie_min,'[0-9.]+')) qie_max,
       t.quantity_units,
       t.dose_cat,
to_number(min_freq) min_freq, 
to_number(max_freq) max_freq, 
       t.frequency_interval,
       t.use_code,
       t.duration_code,
       t.risk_code,
       t.dfu_group_code,
       t.prep_group_code,
       t.sub_pop_code,
to_number(ratio_min) ratio_min, 
to_number(ratio_max) ratio_max,
       t.mi_dose_code,
       t.mi_dose_code_ref,
       t.dosage_form_group,
       t.storage_conditions_group_code,
       t.ingred_group_id,
       t.sub_ingred_id_nhpid,
       t.subing_name_nhpid,
       t.roa_id,
       t.quantity_unit_id,
       t.frequency_unit_id,
       t.source_nhpid_name,
       t.source_ingred_id_nhpid,
       t.nhpid_mono_code,
       t.mono_id,
       t.ingredient_id,
       t.source_id,
       t.monograph_id,
       t.assessment_dose_id,
       t.useracc_id,
       t.creation_date,
       t.lastupdate_date,
       t.row_id
 from X$ASSESSMENT_DOSE_XREF t
;

prompt Drop primary, unique and foreign key constraints 
alter table X$ASSESSMENT_DOSE_XREF
  drop constraint X$ASSESSMENT_DOSE_XREF_PK cascade drop index;
alter table X$ASSESSMENT_DOSE_XREF
  drop constraint X$ASSESSMENT_DOSE_XREF_FK1;
alter table X$ASSESSMENT_DOSE_XREF
  drop constraint X$ASSESSMENT_DOSE_XREF_FK2;
alter table X$ASSESSMENT_DOSE_XREF
  drop constraint X$ASSESSMENT_DOSE_XREF_FK3;
drop trigger X$ASSESSMENT_DOSE_XREF_TRG;

prompt Rename tables
rename X$ASSESSMENT_DOSE_XREF to X$ASSESSMENT_DOSE_XREF_ORIG;
rename X$ASSESSMENT_DOSE_XREF_x to X$ASSESSMENT_DOSE_XREF;

prompt Create/Recreate primary, unique and foreign key constraints 
alter table X$ASSESSMENT_DOSE_XREF
  add constraint X$ASSESSMENT_DOSE_XREF_PK primary key (ROW_ID) using index ;
alter table X$ASSESSMENT_DOSE_XREF
  add constraint X$ASSESSMENT_DOSE_XREF_FK1 foreign key (INGREDIENT_ID)
  references INGREDIENTS (INGRED_ID);
alter table X$ASSESSMENT_DOSE_XREF
  add constraint X$ASSESSMENT_DOSE_XREF_FK2 foreign key (SOURCE_ID)
  references INGREDIENTS (INGRED_ID);
alter table X$ASSESSMENT_DOSE_XREF
  add constraint X$ASSESSMENT_DOSE_XREF_FK3 foreign key (MONOGRAPH_ID)
  references MONOGRAPHS (MONO_ID);

prompt Create trigger
CREATE OR REPLACE TRIGGER X$ASSESSMENT_DOSE_XREF_TRG
before insert or update on X$ASSESSMENT_DOSE_XREF
for each row
begin
  if INSERTING then
    if :new.row_id is null then
      select X$ASSESSMENT_DOSE_XREF_SEQ.nextval into :new.row_id from dual;
    end if;
    :new.creation_date := sysdate;
  end if;
  :new.lastupdate_date := sysdate;
  :new.useracc_id := nvl(NHPID_APEX_UTIL.GET_APEX_USER_ID,0);
end;
/

prompt Grant/Revoke object privileges 
grant select, references on X$ASSESSMENT_DOSE_XREF to NHPDWEB_BUFFER;
grant select on X$ASSESSMENT_DOSE_XREF to NHPDWEB_USER;
grant select, insert, update, delete on X$ASSESSMENT_DOSE_XREF to NHPID_APEX;
grant select, insert, update, delete, alter on X$ASSESSMENT_DOSE_XREF to RL__NHPDWEB_ADMIN;
grant select on X$ASSESSMENT_DOSE_XREF to RL__NHPDWEB_READ;
grant select on X$ASSESSMENT_DOSE_XREF to R_NHPD_ING_READ;

update x$version set schema_version = 0.29;
commit;

prompt ---------
prompt compile schema and show errors

exec dbms_utility.compile_schema(user);

select object_name, object_type from user_objects where status = 'INVALID';

set linesize 1000 pagesize 9999 trimspool on
col name for a30
col line for 99999
col message_number for 99999
col text for a132
select t.name,
       t.line,
       t.message_number,
       t.text
  from user_errors t
;

spool off

